name: Build macOS Binaries

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-macos-x64:
    name: macOS Intel (x86_64)
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-apple-darwin
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Install create-dmg
      run: brew install create-dmg
    
    - name: Build
      run: cargo build --release --target x86_64-apple-darwin
    
    - name: Strip binary
      run: strip target/x86_64-apple-darwin/release/deepwiki-rs
    
    - name: Create DMG
      run: |
        mkdir -p dmg
        cp target/x86_64-apple-darwin/release/deepwiki-rs dmg/deepwiki-rs
        create-dmg \
          --volname "DeepWiki-RS" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --app-drop-link 425 120 \
          dmg/deepwiki-rs
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: deepwiki-rs-macos-x64
        path: dmg/deepwiki-rs.dmg

  build-macos-arm64:
    name: macOS Apple Silicon (ARM64)
    runs-on: macos-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install create-dmg
      run: brew install create-dmg
      
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-apple-darwin
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('build-macos-arm64/**/Cargo.lock') }}
    
    - name: Build
      run: cargo build --release --target aarch64-apple-darwin
    
    - name: Strip binary
      run: strip target/aarch64-apple-darwin/release/deepwiki-rs
    
    - name: Create DMG
      run: |
        mkdir -p dmg-arm64
        cp target/aarch64-apple-darwin/release/deepwiki-rs dmg-arm64/deepwiki-rs
        create-dmg \
          --volname "DeepWiki-RS (Apple Silicon)" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --app-drop-link 425 120 \
          dmg-arm64/deepwiki-rs
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: deepwiki-rs-macos-arm64
        path: dmg-arm64/deepwiki-rs.dmg

  create-universal:
    name: Create Universal Binary
    runs-on: macos-latest
    needs: [build-macos-x64, build-macos-arm64]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download x64 binary
      uses: actions/download-artifact@v4
      with:
        name: deepwiki-rs-macos-x64
        path: artifacts
    
    - name: Download ARM64 binary
      uses: actions/download-artifact@v4
      with:
        name: deepwiki-rs-macos-arm64
        path: artifacts
    
    - name: Create universal binary
      run: |
        mkdir -p universal
        lipo -create \
          -output universal/deepwiki-rs \
          artifacts/deepwiki-rs \
          artifacts-arm64/deepwiki-rs
    
    - name: Create Universal DMG
      run: |
        mkdir -p dmg-universal
        cp universal/deepwiki-rs dmg-universal/deepwiki-rs
        create-dmg \
          --volname "DeepWiki-RS (Universal)" \
          --volicon "icon.icns" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --app-drop-link 425 120 \
          --app-drop-link 425 220 \
          --text-size 14 \
          dmg-universal/deepwiki-rs
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: deepwiki-rs-macos-universal
        path: dmg-universal/deepwiki-rs.dmg